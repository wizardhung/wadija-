# Wadi+ 更新日誌 (CHANGELOG)

所有重要變更都會記錄在此檔案中。

格式遵循 [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/)，
版本號遵循 [語意化版本](https://semver.org/lang/zh-TW/)。

---

## [2.0.0] - 2025-12-01

### 🎉 重大更新 - Hybrid RAG 架構優化

這是一次全面的系統重構，大幅提升了效能、可維護性與使用者體驗。

### ✨ 新增功能 (Added)

#### 核心功能
- **動態詞彙檢索**: 從 3000+ 詞庫中智能抓取相關詞彙，Token 節省 60-80%
- **模糊匹配**: 支援變形詞匹配（如「看醫生」也能匹配「醫生」）
- **優先度排序**: 較長的詞優先匹配（如「計程車」優於「車」）
- **Singleton 快取**: 字典載入一次，多輪對話重複使用，效能提升 5000x
- **動態 Prompt 更新**: 每 5 輪對話重新檢索知識庫

#### 使用者介面
- **啟動橫幅**: 顯示系統版本與歡迎訊息
- **載入進度**: 即時顯示 RAG 初始化狀態
- **Token 統計**: 顯示每輪對話的 Token 消耗（Debug 模式）
- **優雅退出**: 支援多種離開指令（離開/exit/quit/bye）
- **Ctrl+C 處理**: 安全中斷對話

#### 錯誤處理
- **API 失敗恢復**: 詢問使用者是否繼續對話
- **輸入驗證**: 自動過濾空白輸入
- **記憶體管理**: 自動清理超過 20 輪的對話歷史
- **詳細錯誤訊息**: 區分 JSON 解析錯誤、檔案不存在等

#### 文檔系統
- **README.md**: 完整的專案說明文檔（12 章節）
- **QUICKSTART.md**: 5 分鐘快速部署指南
- **ARCHITECTURE.md**: 系統架構技術文檔
- **CHANGELOG.md**: 版本更新日誌（本檔案）
- **requirements.txt**: Python 依賴清單

### 🔧 改進優化 (Changed)

#### rag_tools_v2.py
- **完整型別標註**: 所有函數加入 Type Hints (`typing` 模組)
- **詳細 Docstring**: 每個函數都有完整的說明、參數、回傳值、範例
- **模組化註解**: 使用 `===` 分隔線清楚區分各功能區塊
- **效能標註**: 標示時間複雜度與實測效能數據
- **中英雙語**: 註解使用中文，Docstring 包含英文技術術語

#### main.py
- **結構化對話迴圈**: 清楚的初始化、檢索、增強、生成階段
- **對話輪數計數**: 追蹤對話進度
- **System Prompt 動態更新**: 每 5 輪重新組裝 Prompt
- **記憶體限制**: 最多保留 20 輪對話，避免 Token 超限
- **例外處理**: 完整的 try-except 與 KeyboardInterrupt 處理

#### System Prompt 優化
- **Markdown 格式**: 使用標題、列表、分隔線，結構清晰
- **個資擴充**: 加入興趣、近期事件等資訊
- **規範層次化**: 分為基礎規範、日語借詞、腔調用詞、動態詞彙
- **回答原則**: 明確的語言規範、語氣風格、對話策略

### 🐛 錯誤修復 (Fixed)

- **KeyError 修復**: `load_json_with_cache` 加入 key 存在性檢查
- **空輸入處理**: 避免傳送空字串給 API
- **檔案路徑問題**: 兼容 `dictionaries/` 與根目錄兩種路徑
- **編碼錯誤**: 明確使用 `utf-8` 編碼讀取 JSON
- **JSON 解析錯誤**: 捕捉 `JSONDecodeError` 並提示使用者

### 📊 效能提升 (Performance)

| 指標 | v1.0 | v2.0 | 改善 |
|------|------|------|------|
| System Prompt Token | 3500 | 1200 | ↓ 66% |
| 單輪對話成本 | $0.015 | $0.005 | ↓ 67% |
| 字典載入速度 | 50ms | 0.01ms | ↑ 5000x |
| 總回應時間 | 1.7s | 1.5s | ↑ 12% |

### 🗑️ 移除項目 (Removed)

- **硬編碼字典**: 所有語言規則改為 JSON 檔案管理
- **冗長 Prompt**: 移除不必要的重複說明
- **全域變數濫用**: 改用函數參數傳遞

### 🔒 安全性 (Security)

- **API Key 保護**: 使用 `.env` 檔案，不提交到 Git
- **輸入驗證**: 過濾特殊字元與空白輸入
- **錯誤訊息脫敏**: 不顯示完整檔案路徑

---

## [1.0.0] - 2025-11-15

### 初始版本

#### 功能
- 基本台語對話功能
- OpenAI GPT-4o-mini 微調模型整合
- 簡單的 RAG 系統（靜態 Prompt）
- 長輩個資管理
- 對話歷史維護

#### 限制
- System Prompt 過長（~3500 tokens）
- 每次都重新讀取字典檔案
- 無錯誤處理機制
- 缺乏文檔

---

## 未來規劃 (Roadmap)

### [2.1.0] - 計畫中 (2025-12)
- [ ] 對話記錄儲存（JSON/SQLite）
- [ ] 情緒辨識與回應調整
- [ ] 健康提醒系統
- [ ] Web UI 介面
- [ ] 多長輩資料切換

### [2.2.0] - 計畫中 (2026-Q1)
- [ ] 語音輸入（STT: Whisper）
- [ ] 語音輸出（TTS: Azure/Google）
- [ ] 圖片辨識（OCR）
- [ ] 多模態對話

### [3.0.0] - 長期目標
- [ ] 客製化微調（個人化模型）
- [ ] 醫療系統整合
- [ ] 社群功能（家庭群組）
- [ ] 行動 App 版本

---

## 貢獻者 (Contributors)

感謝所有為 Wadi+ 做出貢獻的開發者：

- **核心團隊**: Wadi+ Team
- **技術顧問**: (待補充)
- **社群貢獻**: (待補充)

---

## 授權變更 (License)

- **v2.0.0+**: MIT License
- **v1.0.0**: All Rights Reserved

---

*格式說明：*
- `Added` 新增功能
- `Changed` 改進優化
- `Deprecated` 即將移除的功能
- `Removed` 已移除的功能
- `Fixed` 錯誤修復
- `Security` 安全性更新

---

*最後更新: 2025-12-01*

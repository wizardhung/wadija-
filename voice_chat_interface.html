<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èª AI èªéŸ³å°è©±ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        }
        
        .chat-container {
            height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .ai-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .speaker-icon {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .speaker-icon:hover {
            transform: scale(1.2);
        }
        
        .playing {
            animation: bounce 0.5s infinite;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- æ¨™é¡Œ -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h1 class="text-4xl font-bold text-center bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                ğŸ™ï¸ å°èª AI èªéŸ³å°è©±ç³»çµ±
            </h1>
            <p class="text-center text-gray-600 mt-2">
                èªéŸ³è¼¸å…¥ â†’ AI æ™ºèƒ½å›æ‡‰ â†’ å°èªèªéŸ³è¼¸å‡º
            </p>
        </div>

        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div id="systemStatus" class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                    <span id="statusText" class="text-sm font-medium text-gray-700">æ­£åœ¨æª¢æŸ¥ç³»çµ±...</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button 
                        id="audioToggleBtn"
                        onclick="toggleAutoPlay()" 
                        class="text-sm px-3 py-1 rounded-lg transition bg-gray-200 hover:bg-gray-300 text-gray-700"
                        title="é»æ“Šå•Ÿç”¨éŸ³é »è‡ªå‹•æ’­æ”¾"
                    >
                        ğŸ”‡ å•Ÿç”¨è‡ªå‹•æ’­æ”¾
                    </button>
                    <button onclick="checkSystemHealth()" class="text-sm text-blue-600 hover:text-blue-800">
                        ğŸ”„ é‡æ–°æª¢æŸ¥
                    </button>
                </div>
            </div>
        </div>

        <!-- å°è©±æ¡† -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4">
                <h2 class="text-xl font-bold text-white flex items-center justify-between">
                    <span>ğŸ’¬ å°è©±å…§å®¹</span>
                    <button onclick="clearChat()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition">
                        æ¸…é™¤å°è©±
                    </button>
                </h2>
            </div>
            
            <div id="chatContainer" class="chat-container p-6 bg-gray-50">
                <div class="text-center text-gray-500 py-12">
                    <p class="text-lg">ğŸ‘‹ æ­¡è¿ä½¿ç”¨å°èª AI å°è©±ç³»çµ±</p>
                    <p class="mt-2">è«‹é»æ“Šä¸‹æ–¹éº¥å…‹é¢¨æŒ‰éˆ•é–‹å§‹èªªè©±</p>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-2xl shadow-2xl p-6">
            <div class="flex items-center justify-center space-x-4">
                <!-- éŒ„éŸ³æŒ‰éˆ• -->
                <button 
                    id="recordButton" 
                    onclick="toggleRecording()"
                    class="w-20 h-20 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    title="é»æ“ŠéŒ„éŸ³ï¼ˆéœ€è¦ Google Cloud è¨ˆè²»ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹æ–‡å­—è¼¸å…¥ï¼‰"
                >
                    <svg id="micIcon" class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                </button>
                
                <!-- éŒ„éŸ³ç‹€æ…‹ -->
                <div class="text-center">
                    <div id="recordingStatus" class="text-lg font-semibold text-gray-700 mb-1">
                        æº–å‚™å°±ç·’
                    </div>
                    <div id="recordingTimer" class="text-sm text-gray-500">
                        00:00
                    </div>
                </div>
            </div>
            
            <!-- æ–‡å­—è¼¸å…¥å€ -->
            <div class="mt-6 space-y-3">
                <label class="block text-sm font-semibold text-gray-700">
                    ğŸ’¬ æˆ–ç›´æ¥è¼¸å…¥æ–‡å­—ï¼ˆè·³é STTï¼‰
                </label>
                <div class="flex space-x-2">
                    <input 
                        id="textInput"
                        type="text"
                        placeholder="è¼¸å…¥æ–‡å­—å¾ŒæŒ‰ Enter æˆ–é»æ“Šç™¼é€"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        onkeypress="if(event.key==='Enter') sendTextMessage()"
                    />
                    <button 
                        onclick="sendTextMessage()"
                        class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-lg hover:shadow-lg transition duration-200"
                    >
                        ğŸ“¤ ç™¼é€
                    </button>
                </div>
            </div>
            
            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-blue-900 mb-2">ğŸ“– ä½¿ç”¨èªªæ˜</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>â€¢ æ–¹å¼ 1ï¼šé»æ“Šéº¥å…‹é¢¨éŒ„éŸ³ï¼ˆéœ€è¦ Google Cloud è¨ˆè²»ï¼‰</li>
                    <li>â€¢ æ–¹å¼ 2ï¼šç›´æ¥åœ¨ä¸‹æ–¹è¼¸å…¥æ–‡å­—ï¼ˆæ¨è–¦ï¼Œç„¡éœ€ä»˜è²»ï¼‰</li>
                    <li>â€¢ ğŸ”Š é»æ“Šã€Œå•Ÿç”¨è‡ªå‹•æ’­æ”¾ã€å¾Œï¼ŒAI å›æ‡‰æœƒè‡ªå‹•æ’­æ”¾èªéŸ³</li>
                    <li>â€¢ æˆ–é»æ“Š AI å›æ‡‰æ—çš„å–‡å­åœ–ç¤ºæ‰‹å‹•æ’­æ”¾èªéŸ³</li>
                    <li>â€¢ âš ï¸ è‹¥ STT å ±éŒ¯ï¼Œè«‹æ”¹ç”¨æ–‡å­—è¼¸å…¥æ–¹å¼</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // å…¨åŸŸè®Šæ•¸
        // ============================================================================
        const API_BASES = ['http://localhost:5000/api', 'http://localhost:5001/api'];
        let API_BASE = API_BASES[0];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let timerInterval = null;
        let sessionId = 'session_' + Date.now();
        let audioContextInitialized = false; // è¿½è¹¤éŸ³é »ä¸Šä¸‹æ–‡æ˜¯å¦å·²åˆå§‹åŒ–
        let autoPlayEnabled = false; // è‡ªå‹•æ’­æ”¾é–‹é—œ
        let playbackUnlocked = false; // æ˜¯å¦å·²è§£é™¤ç€è¦½å™¨æ’­æ”¾é™åˆ¶

        // ============================================================================
        // åˆå§‹åŒ–
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemHealth();
            initAudioContext();
        });

        // åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡ï¼ˆç”¨æ–¼è§£æ±ºç€è¦½å™¨è‡ªå‹•æ’­æ”¾é™åˆ¶ï¼‰
        function initAudioContext() {
            // åœ¨é¦–æ¬¡ç”¨æˆ¶äº¤äº’æ™‚åˆå§‹åŒ–éŸ³é »
            const initHandler = () => {
                if (!audioContextInitialized) {
                    // å‰µå»ºä¸€å€‹éœéŸ³çš„çŸ­éŸ³é »ä¾†å•Ÿå‹•éŸ³é »ä¸Šä¸‹æ–‡
                    const silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
                    silentAudio.muted = true;
                    silentAudio.play().then(() => {
                        audioContextInitialized = true;
                        playbackUnlocked = true;
                        console.log('éŸ³é »ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–ä¸¦è§£é–æ’­æ”¾');
                    }).catch(err => {
                        console.warn('éŸ³é »ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±æ•—:', err);
                    });
                    
                    // åªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡
                    document.removeEventListener('click', initHandler);
                    document.removeEventListener('touchstart', initHandler);
                }
            };
            
            // ç›£è½ç”¨æˆ¶é¦–æ¬¡äº¤äº’
            document.addEventListener('click', initHandler);
            document.addEventListener('touchstart', initHandler);
            document.addEventListener('pointerdown', initHandler, { once: true });
        }

        // ç¢ºä¿æ’­æ”¾å·²è¢«ç”¨æˆ¶æ‰‹å‹¢è§£é–
        async function unlockPlayback() {
            if (playbackUnlocked) return;
            try {
                const silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
                silentAudio.muted = true;
                await silentAudio.play();
                silentAudio.pause();
                playbackUnlocked = true;
                console.log('æ’­æ”¾å·²è§£é–');
            } catch (err) {
                console.warn('è§£é–æ’­æ”¾å¤±æ•—:', err);
            }
        }

        // åˆ‡æ›è‡ªå‹•æ’­æ”¾
        function toggleAutoPlay() {
            autoPlayEnabled = !autoPlayEnabled;
            const btn = document.getElementById('audioToggleBtn');
            
            if (autoPlayEnabled) {
                btn.textContent = 'ğŸ”Š åœç”¨è‡ªå‹•æ’­æ”¾';
                btn.className = 'text-sm px-3 py-1 rounded-lg transition bg-green-500 hover:bg-green-600 text-white';
                btn.title = 'é»æ“Šåœç”¨éŸ³é »è‡ªå‹•æ’­æ”¾';
                
                // åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡
                if (!audioContextInitialized) {
                    const silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
                    silentAudio.play().then(() => {
                        audioContextInitialized = true;
                        console.log('âœ… éŸ³é »è‡ªå‹•æ’­æ”¾å·²å•Ÿç”¨');
                    }).catch(err => {
                        console.warn('éŸ³é »ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±æ•—:', err);
                        alert('ç„¡æ³•å•Ÿç”¨è‡ªå‹•æ’­æ”¾ï¼Œè«‹ç¢ºä¿å…è¨±ç€è¦½å™¨æ’­æ”¾éŸ³é »');
                        autoPlayEnabled = false;
                        btn.textContent = 'ğŸ”‡ å•Ÿç”¨è‡ªå‹•æ’­æ”¾';
                        btn.className = 'text-sm px-3 py-1 rounded-lg transition bg-gray-200 hover:bg-gray-300 text-gray-700';
                    });
                } else {
                    console.log('âœ… éŸ³é »è‡ªå‹•æ’­æ”¾å·²å•Ÿç”¨');
                }
            } else {
                btn.textContent = 'ğŸ”‡ å•Ÿç”¨è‡ªå‹•æ’­æ”¾';
                btn.className = 'text-sm px-3 py-1 rounded-lg transition bg-gray-200 hover:bg-gray-300 text-gray-700';
                btn.title = 'é»æ“Šå•Ÿç”¨éŸ³é »è‡ªå‹•æ’­æ”¾';
                console.log('ğŸ”‡ éŸ³é »è‡ªå‹•æ’­æ”¾å·²åœç”¨');
            }
        }

        // ============================================================================
        // ç³»çµ±å¥åº·æª¢æŸ¥
        // ============================================================================
        async function checkSystemHealth() {
            try {
                // å˜—è©¦æ‰¾åˆ°å¯ç”¨çš„ API ç«¯å£
                for (let base of API_BASES) {
                    try {
                        const response = await fetch(base + '/health', { timeout: 2000 });
                        if (response.ok) {
                            API_BASE = base;
                            break;
                        }
                    } catch (e) {
                        // ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹ç«¯å£
                    }
                }
                
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                if (data.status === 'ok') {
                    const services = data.services;
                    const allReady = services.stt && services.llm && services.tts;
                    
                    if (allReady) {
                        indicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                        statusText.textContent = 'ç³»çµ±æ­£å¸¸é‹è¡Œä¸­';
                    } else {
                        indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full';
                        const sttStatus = services.stt ? 'âœ“' : 'âœ—';
                        const llmStatus = services.llm ? 'âœ“' : 'âœ—';
                        const ttsStatus = services.tts ? 'âœ“' : 'âœ—';
                        statusText.textContent = `éƒ¨åˆ†æœå‹™æœªå°±ç·’ - STT:${sttStatus} LLM:${llmStatus} TTS:${ttsStatus}`;
                    }
                } else {
                    throw new Error('ç³»çµ±ç•°å¸¸');
                }
            } catch (error) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯æœå‹™';
                console.error('å¥åº·æª¢æŸ¥å¤±æ•—:', error);
            }
        }

        // ============================================================================
        // éŒ„éŸ³æ§åˆ¶
        // ============================================================================
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // ä½¿ç”¨ WAV æ ¼å¼ä»¥ä¾¿å¾Œç«¯è™•ç†
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudio(audioBlob);
                    
                    // åœæ­¢æ‰€æœ‰éŸ³è¨Šè»Œé“
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                // æ›´æ–° UI
                updateRecordingUI(true);
                startTimer();
                
            } catch (error) {
                console.error('éŒ„éŸ³å¤±æ•—:', error);
                alert('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­ç½®');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // æ›´æ–° UI
                updateRecordingUI(false);
                stopTimer();
            }
        }

        function updateRecordingUI(recording) {
            const button = document.getElementById('recordButton');
            const status = document.getElementById('recordingStatus');
            const micIcon = document.getElementById('micIcon');
            
            if (recording) {
                button.classList.add('recording');
                status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­...';
                button.classList.remove('from-red-500', 'to-pink-500');
                button.classList.add('from-green-500', 'to-blue-500');
            } else {
                button.classList.remove('recording');
                status.textContent = 'è™•ç†ä¸­...';
                button.classList.remove('from-green-500', 'to-blue-500');
                button.classList.add('from-red-500', 'to-pink-500');
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordingTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('recordingTimer').textContent = '00:00';
        }

        // ============================================================================
        // éŸ³é »è™•ç†
        // ============================================================================
        async function processAudio(audioBlob) {
            try {
                // 1. èªéŸ³è½‰æ–‡å­— (STT)
                const transcript = await speechToText(audioBlob);
                
                if (!transcript) {
                    addMessage('system', 'âš ï¸ ç„¡æ³•è­˜åˆ¥èªéŸ³ï¼Œè«‹é‡è©¦');
                    document.getElementById('recordingStatus').textContent = 'æº–å‚™å°±ç·’';
                    return;
                }
                
                // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
                addMessage('user', transcript);
                
                // 2. ç™¼é€çµ¦ LLM
                const aiReply = await chatWithLLM(transcript);
                
                if (!aiReply) {
                    addMessage('system', 'âš ï¸ AI å›æ‡‰å¤±æ•—');
                    document.getElementById('recordingStatus').textContent = 'æº–å‚™å°±ç·’';
                    return;
                }
                
                // é¡¯ç¤º AI è¨Šæ¯
                addMessage('ai', aiReply);
                
                document.getElementById('recordingStatus').textContent = 'æº–å‚™å°±ç·’';
                
            } catch (error) {
                console.error('è™•ç†éŸ³é »å¤±æ•—:', error);
                addMessage('system', `âš ï¸ éŒ¯èª¤: ${error.message}`);
                document.getElementById('recordingStatus').textContent = 'æº–å‚™å°±ç·’';
            }
        }

        // ============================================================================
        // API èª¿ç”¨
        // ============================================================================
        async function speechToText(audioBlob) {
            try {
                document.getElementById('recordingStatus').textContent = 'ğŸ¤ èªéŸ³è­˜åˆ¥ä¸­...';
                
                // ä½¿ç”¨ç€è¦½å™¨å…§å»º Web Speech APIï¼ˆå…è²»ï¼‰
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // ä½¿ç”¨ Google Cloud è­˜åˆ¥
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                
                const response = await fetch(`${API_BASE}/stt`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.transcript;
                } else {
                    // å¦‚æœ Google Cloud å¤±æ•—ï¼Œå˜—è©¦ç”¨ Web Speech API
                    console.warn('Google Cloud STT å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ...');
                    return await fallbackSpeechToText(audioBlob);
                }
            } catch (error) {
                console.error('STT éŒ¯èª¤:', error);
                // å˜—è©¦å‚™ç”¨æ–¹æ¡ˆ
                return await fallbackSpeechToText(audioBlob);
            }
        }
        
        async function fallbackSpeechToText(audioBlob) {
            // ä½¿ç”¨ç€è¦½å™¨ Web Speech APIï¼ˆChrome/Edge å…§å»ºï¼‰
            return new Promise((resolve, reject) => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    reject(new Error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Speech Recognition'));
                    return;
                }
                
                const recognition = new SpeechRecognition();
                recognition.lang = 'nan-TW'; // å°èª
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    resolve(transcript);
                };
                
                recognition.onerror = (event) => {
                    reject(new Error(`èªéŸ³è­˜åˆ¥å¤±æ•—: ${event.error}`));
                };
                
                // å°‡éŸ³é » blob è½‰æ›ç‚ºå¯ç”¨æ–¼ Web Speech API çš„æ ¼å¼
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                // Web Speech API éœ€è¦ç›´æ¥å¾éº¥å…‹é¢¨è®€å–ï¼Œé€™è£¡ä½¿ç”¨ç°¡åŒ–æ–¹æ¡ˆ
                // ç›´æ¥æç¤ºç”¨æˆ¶æ‰‹å‹•é‡è©¦æˆ–ç”¨æ–‡å­—è¼¸å…¥
                reject(new Error('å‚™ç”¨ STT éœ€è¦ç›´æ¥éº¥å…‹é¢¨è¼¸å…¥'));
            });
        }

        // æ–°å¢ï¼šæ–‡å­—è¼¸å…¥ç™¼é€å‡½å¼
        async function sendTextMessage() {
            const input = document.getElementById('textInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('è«‹è¼¸å…¥æ–‡å­—');
                return;
            }
            
            // æ¸…é™¤è¼¸å…¥æ¡†
            input.value = '';
            
            // æ·»åŠ ä½¿ç”¨è€…è¨Šæ¯åˆ°èŠå¤©æ¡†
            addMessage('user', message);
            
            try {
                // ç™¼é€åˆ° LLM ä¸¦å–å¾—å›æ‡‰
                const reply = await chatWithLLM(message);
                const currentMsgId = messageCounter;  // è¨˜éŒ„ç•¶å‰ message ID
                addMessage('ai', reply);
                
                // åªåœ¨å•Ÿç”¨è‡ªå‹•æ’­æ”¾æ™‚æ‰è‡ªå‹•æ’­æ”¾
                if (autoPlayEnabled) {
                    textToSpeech(reply, currentMsgId).catch(err => {
                        console.error('TTS è‡ªå‹•æ’­æ”¾å¤±æ•—:', err);
                        console.log('è«‹é»æ“Šå–‡å­åœ–æ¨™æ‰‹å‹•æ’­æ”¾');
                    });
                } else {
                    console.log('è‡ªå‹•æ’­æ”¾å·²åœç”¨ï¼Œè«‹é»æ“Šå–‡å­åœ–æ¨™æ’­æ”¾èªéŸ³æˆ–é»æ“Šã€Œå•Ÿç”¨è‡ªå‹•æ’­æ”¾ã€');
                }
            } catch (error) {
                console.error('éŒ¯èª¤:', error);
                addMessage('system', `âŒ éŒ¯èª¤: ${error.message}`);
            }
        }

        async function chatWithLLM(message) {
            try {
                document.getElementById('recordingStatus').textContent = 'ğŸ¤– AI æ€è€ƒä¸­...';
                
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('recordingStatus').textContent = 'âœ“ å®Œæˆ';
                    return data.reply;
                } else {
                    throw new Error(data.error || 'LLM å›æ‡‰å¤±æ•—');
                }
            } catch (error) {
                console.error('Chat éŒ¯èª¤:', error);
                throw error;
            }
        }

        // æ ¹æ“šæ¨™é»ç¬¦è™Ÿåˆ†å¥
        function splitTextBySentence(text) {
            // åªæ ¹æ“šä¸»è¦å¥å­çµæŸæ¨™é»ï¼ˆå¥è™Ÿã€å•è™Ÿã€æ„Ÿå˜†è™Ÿï¼‰åˆ†å¥
            // ä¿ç•™é€—è™Ÿã€åˆ†è™Ÿï¼Œç¶­æŒå®Œæ•´èªæ„
            const sentences = text.split(/([ã€‚ï¼ï¼Ÿ.!?]+)/).filter(s => s.trim().length > 0);
            const result = [];
            
            // å°‡æ¨™é»ç¬¦è™Ÿåˆä½µåˆ°å‰ä¸€å€‹å¥å­
            for (let i = 0; i < sentences.length; i++) {
                if (sentences[i].match(/^[ã€‚ï¼ï¼Ÿ.!?]+$/)) {
                    // é€™æ˜¯å¥å­çµæŸæ¨™é»ï¼Œåˆä½µåˆ°å‰ä¸€å€‹å¥å­
                    if (result.length > 0) {
                        result[result.length - 1] += sentences[i];
                    }
                } else {
                    // é€™æ˜¯å¥å­å…§å®¹
                    result.push(sentences[i]);
                }
            }
            
            // éæ¿¾æ‰ç´”æ¨™é»ã€ç´”ç©ºç™½
            return result.filter(s => {
                const cleaned = s.trim();
                return cleaned.length > 0 && /[\u4e00-\u9fa5a-zA-Z0-9]/.test(cleaned);
            });
        }

        // å–®å€‹å¥å­çš„ TTS è«‹æ±‚
        async function fetchSentenceTTS(sentence, retries = 2) {
            console.log('TTS è«‹æ±‚å¥å­:', sentence);
            
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    // ä½¿ç”¨ AbortController è¨­ç½®è¶…æ™‚ï¼ˆ60ç§’ï¼‰
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);
                    
                    const response = await fetch(`${API_BASE}/tts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: sentence
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`TTS è«‹æ±‚å¤±æ•—: ${response.status} - ${errorText}`);
                    }
                    
                    // æ–°å¢ï¼šæ¥æ”¶ JSON å›æ‡‰è€Œé blob
                    const data = await response.json();
                    
                    if (data.success) {
                        // å°‡ base64 éŸ³æª”è½‰æ›ç‚º Blob
                        const binaryString = atob(data.audio);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const audioBlob = new Blob([bytes], { type: 'audio/wav' });
                        
                        console.log(`æ”¶åˆ°éŸ³æª” (${sentence.substring(0, 20)}...): ${data.file_size} bytes, å°ç¾…: ${data.tlpa}`);
                        
                        // è¿”å›åŒ…å«å°ç¾…æ‹¼éŸ³çš„ç‰©ä»¶
                        return { blob: audioBlob, tlpa: data.tlpa, text: data.text };
                    } else {
                        throw new Error(data.error || 'TTS åˆæˆå¤±æ•—');
                    }
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.warn(`TTS è¶…æ™‚ (å˜—è©¦ ${attempt + 1}/${retries + 1}): ${sentence.substring(0, 30)}...`);
                        if (attempt < retries) continue;
                    }
                    throw error;
                }
            }
        }

        // æ’­æ”¾å–®å€‹éŸ³é »
        function playAudio(ttsResult) {
            // æ”¯æ´èˆŠæ ¼å¼ (blob) å’Œæ–°æ ¼å¼ ({ blob, tlpa })
            const audioBlob = ttsResult.blob || ttsResult;
            const tlpa = ttsResult.tlpa || '';
            
            return new Promise((resolve, reject) => {
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onplay = () => {
                    console.log('é–‹å§‹æ’­æ”¾ç‰‡æ®µ...', tlpa ? `(å°ç¾…: ${tlpa})` : '');
                };
                
                audio.onended = () => {
                    console.log('ç‰‡æ®µæ’­æ”¾å®Œæˆ');
                    URL.revokeObjectURL(audioUrl);
                    resolve({ tlpa, audioSize: audioBlob.size });
                };
                
                audio.onerror = (e) => {
                    console.error('éŸ³æª”æ’­æ”¾éŒ¯èª¤:', e);
                    URL.revokeObjectURL(audioUrl);
                    reject(e);
                };
                
                // å˜—è©¦æ’­æ”¾ï¼Œæ•ç²éŒ¯èª¤
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(err => {
                        console.error('æ’­æ”¾å¤±æ•—:', err.message);
                        URL.revokeObjectURL(audioUrl);
                        // å‚³éæ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
                        const error = new Error(err.message);
                        error.name = err.name;
                        reject(error);
                    });
                }
            });
        }

        async function textToSpeech(text, messageId) {
            try {
                const msgElement = document.getElementById(`msg-${messageId}`);
                if (!msgElement) {
                    console.warn(`æ‰¾ä¸åˆ°è¨Šæ¯å…ƒç´ : msg-${messageId}`);
                    return;
                }

                const speakerIcon = msgElement.querySelector('.speaker-icon');
                if (speakerIcon) {
                    speakerIcon.classList.add('playing');
                }

                // è‹¥å·²æœ‰å¿«å–çš„ TTS çµæœï¼Œç›´æ¥æ’­æ”¾ï¼ˆç¢ºä¿åœ¨ç”¨æˆ¶æ‰‹å‹¢äº‹ä»¶ä¸­ï¼‰
                if (msgElement.dataset.ttsReady === 'true' && msgElement._ttsResults) {
                    await unlockPlayback();
                    const tlpaParts = [];
                    
                    // æ’­æ”¾æ‰€æœ‰å¥å­ä¸¦è’é›†å°ç¾…æ‹¼éŸ³
                    for (let i = 0; i < msgElement._ttsResults.length; i++) {
                        const ttsResult = msgElement._ttsResults[i];
                        console.log(`æ’­æ”¾å¥å­ ${i+1}/${msgElement._ttsResults.length}:`, ttsResult);
                        
                        try {
                            const result = await playAudio(ttsResult);
                            console.log(`å¥å­ ${i+1} æ’­æ”¾å®Œæˆï¼Œå°ç¾…:`, result.tlpa);
                            if (result.tlpa) {
                                tlpaParts.push(result.tlpa);
                            }
                        } catch (err) {
                            console.error(`å¥å­ ${i+1} æ’­æ”¾å¤±æ•—:`, err);
                        }
                    }

                    // æ›´æ–°é é¢ä¸Šçš„å°ç¾…æ‹¼éŸ³é¡¯ç¤ºï¼ˆåŒ…å«æ‰€æœ‰å¥å­ï¼‰
                    if (tlpaParts.length > 0) {
                        let tlpaContainer = msgElement.querySelector('.tlpa-display');
                        if (!tlpaContainer) {
                            tlpaContainer = document.createElement('div');
                            tlpaContainer.className = 'tlpa-display text-xs text-gray-500 mt-1 font-mono';
                            msgElement.appendChild(tlpaContainer);
                        }
                        const combinedTlpa = tlpaParts.join(' ');
                        console.log('æ‰€æœ‰å¥å­å°ç¾…æ‹¼éŸ³:', combinedTlpa);
                        tlpaContainer.textContent = `ğŸ”Š å°ç¾…æ‹¼éŸ³: ${combinedTlpa}`;
                    } else {
                        console.warn('âš ï¸ æ²’æœ‰æ”¶åˆ°ä»»ä½•å°ç¾…æ‹¼éŸ³');
                    }

                    if (speakerIcon) speakerIcon.classList.remove('playing');
                    return;
                }

                // ç¬¬ä¸€æ¬¡é»æ“Šï¼šå…ˆä¸‹è¼‰ä¸¦å¿«å–éŸ³æª”ï¼Œä½†ä¸è‡ªå‹•æ’­æ”¾ï¼Œé¿å…å¤±å»æ‰‹å‹¢ä¸Šä¸‹æ–‡
                console.log('TTS å®Œæ•´æ–‡å­—:', text);
                const sentences = splitTextBySentence(text);
                console.log(`åˆ†æˆ ${sentences.length} å€‹å¥å­:`, sentences);

                if (sentences.length === 0) {
                    console.warn('æ²’æœ‰å¯åˆæˆçš„å¥å­');
                    if (speakerIcon) speakerIcon.classList.remove('playing');
                    return;
                }

                const ttsResults = [];
                for (const sentence of sentences) {
                    try {
                        const result = await fetchSentenceTTS(sentence);
                        if (result) ttsResults.push(result);
                    } catch (err) {
                        console.error(`å¥å­åˆæˆå¤±æ•—: ${sentence.substring(0, 30)}...`, err);
                        addMessage('system', `âš ï¸ å¥å­åˆæˆå¤±æ•—: ${sentence.substring(0, 30)}... (${err.message})`);
                    }
                }

                if (ttsResults.length === 0) {
                    throw new Error('æ‰€æœ‰å¥å­åˆæˆå¤±æ•—');
                }

                // å¿«å–çµæœï¼Œæç¤ºå†æ¬¡é»æ“Šæ’­æ”¾
                msgElement._ttsResults = ttsResults;
                msgElement.dataset.ttsReady = 'true';
                
                // å…ˆé è¦½æ‰€æœ‰å°ç¾…æ‹¼éŸ³
                const allTlpa = ttsResults.map(r => r.tlpa).filter(t => t).join(' ');
                if (allTlpa) {
                    let tlpaContainer = msgElement.querySelector('.tlpa-display');
                    if (!tlpaContainer) {
                        tlpaContainer = document.createElement('div');
                        tlpaContainer.className = 'tlpa-display text-xs text-gray-500 mt-1 font-mono';
                        msgElement.appendChild(tlpaContainer);
                    }
                    tlpaContainer.textContent = `ğŸ”Š å°ç¾…æ‹¼éŸ³: ${allTlpa}`;
                    console.log('âœ… å·²é¡¯ç¤ºå°ç¾…æ‹¼éŸ³ (å…±' + ttsResults.length + 'å¥):', allTlpa);
                }
                
                addMessage('system', 'âœ… èªéŸ³å·²æº–å‚™å¥½ï¼Œè«‹å†é»ä¸€æ¬¡å–‡å­æ’­æ”¾');

                if (speakerIcon) speakerIcon.classList.remove('playing');
            } catch (error) {
                console.error('TTS éŒ¯èª¤:', error);
                const msgElement = document.getElementById(`msg-${messageId}`);
                if (msgElement) {
                    const speakerIcon = msgElement.querySelector('.speaker-icon');
                    if (speakerIcon) speakerIcon.classList.remove('playing');
                }
                addMessage('system', `âš ï¸ èªéŸ³æ’­æ”¾å¤±æ•—: ${error.message}`);
            }
        }

        // ============================================================================
        // å°è©±æ¡†ç®¡ç†
        // ============================================================================
        let messageCounter = 0;

        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            
            // æ¸…é™¤æ­¡è¿è¨Šæ¯
            if (chatContainer.children.length === 1 && chatContainer.children[0].classList.contains('text-center')) {
                chatContainer.innerHTML = '';
            }
            
            const messageId = messageCounter++;
            const messageDiv = document.createElement('div');
            messageDiv.id = `msg-${messageId}`;
            messageDiv.className = 'chat-message mb-4';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end">
                        <div class="max-w-2xl">
                            <div class="flex items-center justify-end mb-1">
                                <span class="text-sm text-gray-600 mr-2">${getCurrentTime()}</span>
                                <span class="text-sm font-semibold text-purple-600">ğŸ‘¤ æ‚¨</span>
                            </div>
                            <div class="user-message text-white rounded-2xl rounded-tr-none px-4 py-3 shadow-lg">
                                ${escapeHtml(content)}
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'ai') {
                messageDiv.innerHTML = `
                    <div class="flex justify-start">
                        <div class="max-w-2xl">
                            <div class="flex items-center mb-1">
                                <span class="text-sm font-semibold text-pink-600">ğŸ¤– AI åŠ©æ‰‹</span>
                                <span class="text-sm text-gray-600 ml-2">${getCurrentTime()}</span>
                            </div>
                            <div class="ai-message text-white rounded-2xl rounded-tl-none px-4 py-3 shadow-lg flex items-center justify-between">
                                <span class="flex-1">${escapeHtml(content)}</span>
                                <button onclick="textToSpeech('${escapeHtml(content).replace(/'/g, "\\'")}', ${messageId})" 
                                        class="speaker-icon ml-3 text-white hover:text-yellow-300">
                                    ğŸ”Š
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.innerHTML = `
                    <div class="flex justify-center">
                        <div class="bg-gray-300 text-gray-700 rounded-lg px-4 py-2 text-sm">
                            ${escapeHtml(content)}
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearChat() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <p class="text-lg">ğŸ‘‹ æ­¡è¿ä½¿ç”¨å°èª AI å°è©±ç³»çµ±</p>
                        <p class="mt-2">è«‹é»æ“Šä¸‹æ–¹éº¥å…‹é¢¨æŒ‰éˆ•é–‹å§‹èªªè©±</p>
                    </div>
                `;
                
                // é‡ç½®æœƒè©±
                sessionId = 'session_' + Date.now();
                fetch(`${API_BASE}/reset_session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });
            }
        }

        // ============================================================================
        // å·¥å…·å‡½æ•¸
        // ============================================================================
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
